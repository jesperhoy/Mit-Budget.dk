/*!Katla v. 2.0.0 - Copyright 2024 Jesper Hoy*/
"use strict";(()=>{var b=class{html;constructor(e){this.html=e}};function N(t,e){let o=document.createElement("template");return o.innerHTML=t.html,e.node2.parentNode.insertBefore(o.content,e.node2),{Update:r=>{},Unload:()=>{},MatchForUpdate:r=>r.html===t.html}}var y=new Map;y.set("validity",(t,e,o,r)=>{let i=t;function a(l){if(typeof l!="string")throw new Error("Katla: #validity value must be string");i.setCustomValidity(l)}return a(e),a});y.set("ref",(t,e,o,r)=>{if(typeof e!="function")throw new Error("Katla: #ref value must be function");return e(t),()=>{}});y.set("bind",(t,e,o,r)=>{let i=t.tagName.toLowerCase();i==="input"&&(i=t.type,i||(i="text"),i=i.toLowerCase());let a,l,n,s=o.indexOf("trim")>=0;function p(){let m=t.value;return(i==="number"||i==="range"||o.indexOf("number")>=0)&&(m=parseInt(m)),s&&(m=m.trim()),m}function u(){if(l=void 0,Array.isArray(e)&&e.length===2)if(Array.isArray(e[0])&&typeof e[1]=="number")a=e[0][e[1]],l=m=>e[0][e[1]]=m;else if(typeof e[0]=="object"&&typeof e[1]=="string"){if(!e[0].hasOwnProperty(e[1]))throw new Error("Katla: "+i+" #bind to object does not have property '"+e[1]+"'");a=e[0][e[1]],l=m=>e[0][e[1]]=m}else typeof e[0]=="function"&&typeof e[1]=="function"?(a=e[0](),l=e[1]):typeof e[1]=="function"&&(a=e[0],l=e[1]);else if(Array.isArray(e)&&e.length===1&&Array.isArray(e[0])){if(i!=="checkbox")throw new Error("Katla: Can only #bind to [Array] with input/checkbox");a=e[0],l=()=>{}}if(!l)throw new Error("Katla: Can only #bind to {object}.PropName / [Object,string] / [Array,number] / [getFunc,setFunc]");if(i==="radio"){if(!t.hasAttribute("value"))throw new Error("Katla: input/radio element missing 'value' attribute - for #bind");let m=p(),f=a===m;if(f===n)return;t.checked=f,n=f}else if(i==="checkbox")if(typeof a=="boolean"){if(a===n)return;t.checked=a,n=a;return}else{if(!Array.isArray(a))throw new Error("Katla: #bind value for input/checkbox must be either boolean or array");if(!t.hasAttribute("value"))throw new Error("Katla: input/checkbox element missing 'value' attribute - for #bind with array value");let m=p(),f=a.indexOf(m)>=0;if(f===n)return;t.checked=f,n=f}else{if(a===n)return;t.value=Number.isNaN(a)?"":a.toString(),n=a}}u();function c(m){let f=p();if(i==="radio"){if(!t.checked)return;l(f),n=f}else if(i==="checkbox"){let d=t.checked;if(typeof a=="boolean")l(d);else{let A=a.indexOf(f);d&&A<0&&a.push(f),!d&&A>=0&&a.splice(A,1)}n=d}else l(f),n=f,s&&m.type==="change"&&t.value!==n&&(t.value=n);o.indexOf("noredraw")<0&&r()}let h=o.indexOf("eager")>=0;return h&&t.addEventListener("input",c),(!h||s)&&t.addEventListener("change",c),m=>{e=m,u()}});function T(t,e,o,r,i){let a=i,l;if(e.charAt(0)==="@"){if(typeof i!="function")throw new Error("Katla: '"+e+"' handler must be function");let n=e.substr(1).split("|"),s={capture:n.indexOf("capture")>0,once:n.indexOf("once")>0,passive:n.indexOf("passive")>0};t.addEventListener(n[0],p=>{if(n.indexOf("self")>0&&p.target!==t)return;n.indexOf("prevent")>0&&p.preventDefault(),n.indexOf("stop")>0&&p.stopPropagation();let u=a(p);n.includes("noredraw")||(r.$redraw(),u instanceof Promise&&u.then(()=>r.$redraw()))},s)}else if(e.charAt(0)===".")t[e.substr(1)]=i;else if(e.charAt(0)==="#"){let n=e.substr(1).split("|"),s=y.get(n[0]);if(s===void 0)throw new Error("Katla: Unknown directive '#"+n[0]+"'");l=s(t,i,n.slice(1),()=>r.$redraw())}else i===!1||i===null||i===void 0||(i===!0?t.setAttribute(e,""):t.setAttribute(e,i.toString()));return{GetData:o,Update:n=>{if(!(n===a&&typeof n!="object"))if(a=n,e.charAt(0)==="@"){if(typeof n!="function")throw new Error("Katla: "+e+" handler must be function")}else e.charAt(0)==="."?t[e.substr(1)]=n:e.charAt(0)==="#"?l(n):n===!1||n===null||n===void 0?t.removeAttribute(e):n===!0?t.setAttribute(e,""):t.setAttribute(e,n.toString())},Unload:()=>{}}}function P(t,e,o){let r=t.bldr.MakeLive(t.args,e.node2,o);return{Update:i=>r.Update(i.args),Unload:r.Unload,MatchForUpdate:i=>i.bldr===t.bldr}}var w=class{bldr;args;constructor(e,o){this.bldr=e,this.args=o}};function $(t,e){let o=document.createTextNode(t.toString());return e.node2.parentNode.insertBefore(o,e.node2),{Update:r=>{r!==t&&(t=r,o.data=r.toString())},Unload:()=>{},MatchForUpdate:r=>!0}}var O=class{static wrap(e,o){return o?[this,e,o]:e?[this,e]:[this]}load(){}unload(){}$redraw;$parent;$set;$get};function K(t,e,o){let r=new t[0];r.$parent=o,r.$redraw=()=>o.$redraw(),r.$app={redraw:()=>r.$redraw()};let i;if(r.$get=p=>{if(i){let u=i.get(p);if(u!==void 0)return u}if(o!==void 0)return o.$get(p)},r.$set=(p,u)=>{i||(i=new Map),i.set(p,u)},t.length>1&&Object.assign(r,t[1]),t.length>2&&t[2](r),r.load&&r.load(),!r.render||typeof r.render!="function")throw new Error("Katla: Component must have .render method");let a=r.render(),l=C(a),n=v(a,e,r),s=!1;return{Update:p=>{if(s)return;t=p,t.length>1&&Object.assign(r,t[1]),a=r.render();let u=C(a);u!==5&&(l===u&&n.MatchForUpdate(a)?n.Update(a):(n.Unload(),e.ClearContent(),l=u,n=v(a,e,r)))},Unload:()=>{s||(r.unload&&r.unload(),n.Unload(),s=!0)},MatchForUpdate:p=>t[0]===p[0]}}function k(t,e,o){let r=[];i(t);function i(a){if(a.length===0)return;let l=document.createDocumentFragment(),n=document.createComment("");l.append(n);let s,p;for(let u of a)p=document.createComment(""),l.append(p),s=g(n,-1,o,u),r.push(s),n=p;e.node2.parentNode.insertBefore(l,e.node2)}return{Update:a=>{if(r.length===0){i(a);return}if(a.length===0){e.ClearContent(),r=[];return}let l,n;for(let s=0;s<a.length||s<r.length;s++)if(s<a.length&&s<r.length)r[s].Update(a[s]);else if(a.length<r.length)l=r[s],l.Unload(),l.ClearContent(),l.node1.parentNode.removeChild(l.node1),r[s-1].node2=l.node2,r.splice(s,1),s-=1;else{let p=document.createComment("");l=r[r.length-1],l.node2.parentNode.insertBefore(p,l.node2),n=g(p,-1,o,a[s]),l.node2=p,r.push(n)}},Unload:()=>{r.forEach(a=>a.Unload()),r=[]},MatchForUpdate:a=>!0}}function C(t){if(t===null||t===""||t===!1)return 0;if(t instanceof w)return 4;if(Array.isArray(t))return t.length>0&&typeof t[0]=="function"?2:6;if(t instanceof b)return 3;if(t instanceof x)return 5;if(typeof t=="string"||typeof t=="number"||typeof t=="object")return 1;throw new Error("Katla: Unknown content type: "+typeof t)}function v(t,e,o){switch(C(t)){case 0:return{Update:i=>{},Unload:()=>{},MatchForUpdate:i=>!0};case 1:return $(t,e);case 2:return K(t,e,o);case 3:return N(t,e);case 4:return P(t,e,o);case 6:return k(t,e,o);case 5:throw new Error("Katla: NoChange at creation")}}var x=class{};function g(t,e,o,r){let i=C(r),a,l={GetData:n=>n[e],node1:t,node2:t.nextSibling,Update:n=>{let s=C(n);s!==5&&(i===s&&a.MatchForUpdate(n)?a.Update(n):(a.Unload(),l.ClearContent(),i=s,a=v(n,l,o)))},ClearContent:()=>{let n=l.node1.nextSibling;for(;n!==l.node2;)l.node1.parentNode.removeChild(n),n=l.node1.nextSibling},Unload:()=>()=>a.Unload()};return a=v(r,l,o),l}var E=class{#e=[];#t=document.createElement("template");constructor(e){let o="";for(let r=0;r<e.length-1;r++)o+=e[r],o+=this.#n(o)?"{{fv"+r+"}}":"<!--{{fv"+r+"}}-->";o+=e[e.length-1],this.#t.innerHTML=o,this.#r(this.#t.content,[])}#n(e){return e.lastIndexOf("<")>e.lastIndexOf(">")}#r(e,o){let r,i,a,l,n,s;for(let p=0;p<e.childNodes.length;p++)if(r=e.childNodes[p],s=o.concat(p),r.nodeType===1){let u=r;u.tagName.toLowerCase()==="select"&&this.#r(r,s);let c=[],h=[],m=!1;for(let f=0;f<u.attributes.length;f++){if(n=u.attributes[f],n.name==="class"){if(c.length>0)throw new Error("Katla: Cannot combine 'class' and 'class:...' attributes on same element");m=!0}if(i=n.value,a=i.indexOf("{{fv"),a<0){if(n.name.startsWith("class:"))throw new Error("Katla: "+n.name+" attribute must have ${boolean} value");(n.name.charAt(0)==="#"||n.name.charAt(0)===".")&&((n.name.charAt(0)==="#"?h:this.#e).push(j(s,n.name,i)),u.removeAttribute(n.name),f-=1);continue}let d=[];for(;a>=0;){if(a>0&&d.push(i.substr(0,a)),i=i.substr(a+4),a=i.indexOf("}}"),a<0)throw new Error("Katla: Unexpected missing }}");l=parseInt(i.substr(0,a)),d.push(l),i=i.substr(a+2),a=i.indexOf("{{fv")}if(i.length>0&&d.push(i),d.length===1)if(n.name.startsWith("class:")){if(m)throw new Error("Katla: Cannot combine 'class' and 'class:...' attributes on same element");c.push({class:n.name.substr(6),argidx:d[0]})}else(n.name.charAt(0)==="#"?h:this.#e).push(F(s,n.name,d[0]));else{if(n.name.startsWith("class:"))throw new Error("Katla: "+n.name+" attribute must have ${boolean} value");(n.name.charAt(0)==="#"?h:this.#e).push(S(s,n.name,d))}u.removeAttribute(n.name),f-=1}c.length>0&&this.#e.push(W(s,c)),this.#e.push(...h),u.tagName.toLowerCase()!=="select"&&this.#r(r,s)}else if(r.nodeType===8){let u=r;u.data.substr(0,4)==="{{fv"&&(l=parseInt(u.data.substr(4,u.data.length-6)),u.data="",e.insertBefore(document.createComment(""),r),this.#e.push(B(s,l)),p+=1)}}MakeLive(e,o,r){let i=this.#t.content.cloneNode(!0),a=this.#e.map(l=>{let n=i;return l.path.forEach(s=>n=n.childNodes[s]),{ph:l,n}}).map(l=>l.ph.CreateOp(l.n,r,e)).filter(l=>l!==null);return o.parentNode.insertBefore(i,o),{Update:l=>{for(let n of a)n.Update(n.GetData(l))},Unload:()=>{for(let l of a)l.Unload()}}}};function j(t,e,o){return{path:t,CreateOp(r,i,a){let l=n=>o;return T(r,e,l,i,l(a)),null}}}function F(t,e,o){return e.startsWith("_")&&(e=e.substring(1)),{path:t,CreateOp(r,i,a){let l=n=>n[o];return T(r,e,l,i,l(a))}}}function S(t,e,o){return e.startsWith("_")&&(e=e.substring(1)),{path:t,CreateOp(r,i,a){let l;return(e==="#bind"||e.substr(0,6)==="#bind|")&&o.length===2&&typeof o[1]=="string"&&o[1].charAt(0)==="."?l=n=>[n[o[0]],o[1].substr(1)]:l=n=>o.map(s=>typeof s=="string"?s:n[s].toString()).join(""),T(r,e,l,i,l(a))}}}function W(t,e){return{path:t,CreateOp(o,r,i){let a=l=>{let n="",s;for(let p=0;p<e.length;p++){if(s=l[e[p].argidx],typeof s!="boolean")throw new Error("Katla: class:"+e[p].class+" value must be boolean");s&&(n+=(n.length>0?" ":"")+e[p].class)}return n.length===0?!1:n};return T(o,"class",a,r,a(i))}}}function B(t,e){return{path:t,CreateOp(o,r,i){return g(o,e,r,i[e])}}}var R=new Map;function M(t,...e){let o=R.get(t);return o||(o=new E(t),R.set(t,o)),new w(o,e)}function H(t,e){let o=new U(t,e);return()=>o.$redraw()}var U=class{constructor(e,o){typeof e=="string"&&(e=document.querySelector(e));let r=document.createDocumentFragment(),i=document.createComment("Katla");r.appendChild(i);let a=document.createComment("/Katla");r.appendChild(a);let l=g(i,-1,this,o());this.#e=()=>l.Update(o()),e.appendChild(r)}render(){}#e;#t=performance.now();#n;#r;$redraw(){if(!this.#n){let e=()=>{let r=this.#r;this.#n=null,this.#t=new Date().getTime(),this.#e(),r()};this.#n=new Promise((r,i)=>this.#r=r);let o=this.#t+33-performance.now();o<=0?queueMicrotask(e):setTimeout(e,o)}return this.#n}#o=new Map;$get=e=>this.#o.get(e);$set=(e,o)=>{this.#o.set(e,o)}};var L=class extends O{deps;render2;#e;render(){if(this.#e&&this.#e.length===this.deps.length){let e=!0;for(let o=0;o<this.#e.length;o++)if(this.#e[o]!==this.deps[o]){e=!1;break}if(e)return this.deps=void 0,new x}return this.#e=Object.assign({},this.deps),this.deps=void 0,this.render2()}};function D(t,e){if(!t||!Array.isArray(t))throw new Error("Katla: memo deps argument must be array");if(!e||typeof e!="function")throw new Error("Katla: memo render argument must be function");return[L,{deps:t,render2:e}]}var V=t=>new b(t),G=(t,e)=>y.set(t,e),q=(t,e)=>({redraw:H(t,e)});globalThis.Katla={app:q,html:M,mount:H,raw:V,directive:G,memo:D,Component:O};globalThis.html=M;})();
//# sourceMappingURL=katla.js.map
