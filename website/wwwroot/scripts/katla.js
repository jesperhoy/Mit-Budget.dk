/*!Katla v. 3.0.1 - Copyright 2024 Jesper Hoy*/
"use strict";(()=>{var b=class{html;constructor(e){this.html=e}};function H(t,e){let i=document.createElement("template");return i.innerHTML=t.html,e.node2.parentNode.insertBefore(i.content,e.node2),{Update:r=>{},Unload:()=>{},MatchForUpdate:r=>r.html===t.html}}var y=new Map;y.set("validity",(t,e,i,r)=>{let l=t;function a(o){if(typeof o!="string")throw new Error("Katla: #validity value must be string");l.setCustomValidity(o)}return a(e),a});y.set("ref",(t,e,i,r)=>{if(typeof e!="function")throw new Error("Katla: #ref value must be function");return e(t),()=>{}});y.set("bind",(t,e,i,r)=>{let l=t.tagName.toLowerCase();l==="input"&&(l=t.type,l||(l="text"),l=l.toLowerCase());let a,o,n,s=i.indexOf("trim")>=0;function u(){let m=t.value;return(l==="number"||l==="range"||i.indexOf("number")>=0)&&(m=parseInt(m)),s&&(m=m.trim()),m}function p(){if(o=void 0,Array.isArray(e)&&e.length===2)if(Array.isArray(e[0])&&typeof e[1]=="number")a=e[0][e[1]],o=m=>e[0][e[1]]=m;else if(typeof e[0]=="object"&&typeof e[1]=="string"){if(!e[0].hasOwnProperty(e[1]))throw new Error("Katla: "+l+" #bind to object does not have property '"+e[1]+"'");a=e[0][e[1]],o=m=>e[0][e[1]]=m}else typeof e[0]=="function"&&typeof e[1]=="function"?(a=e[0](),o=e[1]):typeof e[1]=="function"&&(a=e[0],o=e[1]);else if(Array.isArray(e)&&e.length===1&&Array.isArray(e[0])){if(l!=="checkbox")throw new Error("Katla: Can only #bind to [Array] with input/checkbox");a=e[0],o=()=>{}}if(!o)throw new Error("Katla: Can only #bind to {object}.PropName / [Object,string] / [Array,number] / [value,setFunc] / [Array]");if(l==="radio"){if(!t.hasAttribute("value"))throw new Error("Katla: input/radio element missing 'value' attribute - for #bind");let m=u(),c=a===m;if(c===n)return;t.checked=c,n=c}else if(l==="checkbox")if(typeof a=="boolean"){if(a===n)return;t.checked=a,n=a;return}else{if(!Array.isArray(a))throw new Error("Katla: #bind value for input/checkbox must be either boolean or array");if(!t.hasAttribute("value"))throw new Error("Katla: input/checkbox element missing 'value' attribute - for #bind with array value");let m=u(),c=a.indexOf(m)>=0;if(c===n)return;t.checked=c,n=c}else if(l==="file")(!a||!a.files||a.files.length===0)&&(t.value="");else{if(a===n)return;t.value=Number.isNaN(a)?"":a.toString(),n=a}}p();function f(m){let c=u();if(l==="radio"){if(!t.checked)return;o(c),n=c}else if(l==="checkbox"){let h=t.checked;if(typeof a=="boolean")o(h);else{let E=a.indexOf(c);h&&E<0&&a.push(c),!h&&E>=0&&a.splice(E,1)}n=h}else l==="file"?(t.id||(t.id="file-"+Math.floor(Math.random()*Date.now()).toString(36)),o({id:t.id,files:Array.from(t.files).map(h=>({name:h.name,size:h.size,type:h.type,lastModified:h.lastModified}))})):(o(c),n=c,s&&m.type==="change"&&t.value!==n&&(t.value=n));i.indexOf("noredraw")<0&&r()}let d=i.indexOf("eager")>=0;return d&&t.addEventListener("input",f),(!d||s)&&t.addEventListener("change",f),m=>{e=m,p()}});function v(t,e,i,r,l){let a=l,o;if(e.charAt(0)==="@"){if(typeof l!="function")throw new Error("Katla: '"+e+"' handler must be function");let n=e.substr(1).split("|");t.addEventListener(n[0],s=>{if(n.indexOf("self")>0&&s.target!==t)return;n.indexOf("prevent")>0&&s.preventDefault(),n.indexOf("stop")>0&&s.stopPropagation();let u=a(s);n.includes("noredraw")||(u instanceof Promise?u.then(()=>r.$redraw()):r.$redraw())},{capture:n.indexOf("capture")>0,once:n.indexOf("once")>0,passive:n.indexOf("passive")>0})}else if(e.charAt(0)===".")t[e.substr(1)]=l;else if(e.charAt(0)==="#"){let n=e.substr(1).split("|"),s=y.get(n[0]);if(s===void 0)throw new Error("Katla: Unknown directive '#"+n[0]+"'");o=s(t,l,n.slice(1),()=>r.$redraw())}else l===!1||l===null||l===void 0||(l===!0?t.setAttribute(e,""):t.setAttribute(e,l.toString()));return{GetData:i,Update:n=>{if(!(n===a&&typeof n!="object"))if(a=n,e.charAt(0)==="@"){if(typeof n!="function")throw new Error("Katla: "+e+" handler must be function")}else e.charAt(0)==="."?t[e.substr(1)]=n:e.charAt(0)==="#"?o(n):n===!1||n===null||n===void 0?t.removeAttribute(e):n===!0?t.setAttribute(e,""):t.setAttribute(e,n.toString())},Unload:()=>{}}}function S(t,e,i){let r=t.bldr.MakeLive(t.args,e.node2,i);return{Update:l=>r.Update(l.args),Unload:r.Unload,MatchForUpdate:l=>l.bldr===t.bldr}}var w=class{bldr;args;constructor(e,i){this.bldr=e,this.args=i}};function L(t,e){let i=document.createTextNode(t.toString());return e.node2.parentNode.insertBefore(i,e.node2),{Update:r=>{r!==t&&(t=r,i.data=r.toString())},Unload:()=>{},MatchForUpdate:r=>!0}}function F(t,e,i){let r=new t[0];r.$parent=i,r.$redraw=()=>i.$redraw(),r.$app={redraw:()=>i.$redraw()};let l;if(r.$get=u=>{if(l){let p=l.get(u);if(p!==void 0)return p}if(i!==void 0)return i.$get(u)},r.$set=(u,p)=>{l||(l=new Map),l.set(u,p)},t.length>1&&Object.assign(r,t[1]),t.length>2&&t[2](r),r.load&&r.load(),!r.render||typeof r.render!="function")throw new Error("Katla: Component must have .render method");let a=r.render(),o=g(a),n=O(a,e,r),s=!1;return{Update:u=>{if(s)return;t=u,t.length>1&&Object.assign(r,t[1]),a=r.render();let p=g(a);p!==5&&(o===p&&n.MatchForUpdate(a)?n.Update(a):(n.Unload(),e.ClearContent(),o=p,n=O(a,e,r)))},Unload:()=>{s||(r.unload&&r.unload(),n.Unload(),s=!0)},MatchForUpdate:u=>t[0]===u[0]}}function N(t,e,i){let r=[];l(t);function l(a){if(a.length===0)return;let o=document.createDocumentFragment(),n=document.createComment("");o.append(n);let s,u;for(let p of a)u=document.createComment(""),o.append(u),s=C(n,-1,i,p),r.push(s),n=u;e.node2.parentNode.insertBefore(o,e.node2)}return{Update:a=>{if(r.length===0){l(a);return}if(a.length===0){e.ClearContent(),r=[];return}let o,n;for(let s=0;s<a.length||s<r.length;s++)if(s<a.length&&s<r.length)r[s].Update(a[s]);else if(a.length<r.length)o=r[s],o.Unload(),o.ClearContent(),o.node1.parentNode.removeChild(o.node1),r[s-1].node2=o.node2,r.splice(s,1),s-=1;else{let u=document.createComment("");o=r[r.length-1],o.node2.parentNode.insertBefore(u,o.node2),n=C(u,-1,i,a[s]),o.node2=u,r.push(n)}},Unload:()=>{r.forEach(a=>a.Unload()),r=[]},MatchForUpdate:a=>!0}}function g(t){if(t===null||t===""||t===!1)return 0;if(t instanceof w)return 4;if(Array.isArray(t))return t.length>0&&typeof t[0]=="function"?2:6;if(t instanceof b)return 3;if(t instanceof x)return 5;if(typeof t=="string"||typeof t=="number"||typeof t=="object")return 1;throw new Error("Katla: Unknown content type: "+typeof t)}function O(t,e,i){switch(g(t)){case 0:return{Update:l=>{},Unload:()=>{},MatchForUpdate:l=>!0};case 1:return L(t,e);case 2:return F(t,e,i);case 3:return H(t,e);case 4:return S(t,e,i);case 6:return N(t,e,i);case 5:throw new Error("Katla: NoChange at creation")}}var x=class{};function C(t,e,i,r){let l=g(r),a,o={GetData:n=>n[e],node1:t,node2:t.nextSibling,Update:n=>{let s=g(n);s!==5&&(l===s&&a.MatchForUpdate(n)?a.Update(n):(a.Unload(),o.ClearContent(),l=s,a=O(n,o,i)))},ClearContent:()=>{let n=o.node1.nextSibling;for(;n!==o.node2;)o.node1.parentNode.removeChild(n),n=o.node1.nextSibling},Unload:()=>()=>a.Unload()};return a=O(r,o,i),o}var T=class{#e=[];#t=document.createElement("template");constructor(e){let i="";for(let r=0;r<e.length-1;r++)i+=e[r],i+=this.#r(i)?"{{fv"+r+"}}":"<!--{{fv"+r+"}}-->";i+=e[e.length-1],this.#t.innerHTML=i,this.#n(this.#t.content,[])}#r(e){return e.lastIndexOf("<")>e.lastIndexOf(">")}#n(e,i){let r,l,a,o,n,s;for(let u=0;u<e.childNodes.length;u++)if(r=e.childNodes[u],s=i.concat(u),r.nodeType===1){let p=r;p.tagName.toLowerCase()==="select"&&this.#n(r,s);let f=[],d=[],m=!1;for(let c=0;c<p.attributes.length;c++){if(n=p.attributes[c],n.name==="class"){if(f.length>0)throw new Error("Katla: Cannot combine 'class' and 'class:...' attributes on same element");m=!0}if(l=n.value,a=l.indexOf("{{fv"),a<0){if(n.name.startsWith("class:"))throw new Error("Katla: "+n.name+" attribute must have ${boolean} value");(n.name.charAt(0)==="#"||n.name.charAt(0)===".")&&((n.name.charAt(0)==="#"?d:this.#e).push(R(s,n.name,l)),p.removeAttribute(n.name),c-=1);continue}let h=[];for(;a>=0;){if(a>0&&h.push(l.substr(0,a)),l=l.substr(a+4),a=l.indexOf("}}"),a<0)throw new Error("Katla: Unexpected missing }}");o=parseInt(l.substr(0,a)),h.push(o),l=l.substr(a+2),a=l.indexOf("{{fv")}if(l.length>0&&h.push(l),h.length===1)if(n.name.startsWith("class:")){if(m)throw new Error("Katla: Cannot combine 'class' and 'class:...' attributes on same element");f.push({class:n.name.substr(6),argidx:h[0]})}else(n.name.charAt(0)==="#"?d:this.#e).push(V(s,n.name,h[0]));else{if(n.name.startsWith("class:"))throw new Error("Katla: "+n.name+" attribute must have ${boolean} value");(n.name.charAt(0)==="#"?d:this.#e).push($(s,n.name,h))}p.removeAttribute(n.name),c-=1}f.length>0&&this.#e.push(j(s,f)),this.#e.push(...d),p.tagName.toLowerCase()!=="select"&&this.#n(r,s)}else if(r.nodeType===8){let p=r;p.data.substr(0,4)==="{{fv"&&(o=parseInt(p.data.substr(4,p.data.length-6)),p.data="",e.insertBefore(document.createComment(""),r),this.#e.push(B(s,o)),u+=1)}}MakeLive(e,i,r){let l=this.#t.content.cloneNode(!0),a=this.#e.map(o=>{let n=l;return o.path.forEach(s=>n=n.childNodes[s]),{ph:o,n}}).map(o=>o.ph.CreateOp(o.n,r,e)).filter(o=>o!==null);return i.parentNode.insertBefore(l,i),{Update:o=>{for(let n of a)n.Update(n.GetData(o))},Unload:()=>{for(let o of a)o.Unload()}}}};function R(t,e,i){return{path:t,CreateOp(r,l,a){let o=n=>i;return v(r,e,o,l,o(a)),null}}}function V(t,e,i){return e.startsWith("_")&&(e=e.substring(1)),{path:t,CreateOp(r,l,a){let o=n=>n[i];return v(r,e,o,l,o(a))}}}function $(t,e,i){return e.startsWith("_")&&(e=e.substring(1)),{path:t,CreateOp(r,l,a){let o;return(e==="#bind"||e.substr(0,6)==="#bind|")&&i.length===2&&typeof i[1]=="string"&&i[1].charAt(0)==="."?o=n=>[n[i[0]],i[1].substr(1)]:o=n=>i.map(s=>typeof s=="string"?s:n[s].toString()).join(""),v(r,e,o,l,o(a))}}}function j(t,e){return{path:t,CreateOp(i,r,l){let a=o=>{let n="",s;for(let u=0;u<e.length;u++){if(s=o[e[u].argidx],typeof s!="boolean")throw new Error("Katla: class:"+e[u].class+" value must be boolean");s&&(n+=(n.length>0?" ":"")+e[u].class)}return n.length===0?!1:n};return v(i,"class",a,r,a(l))}}}function B(t,e){return{path:t,CreateOp(i,r,l){return C(i,e,r,l[e])}}}var P=new Map;function A(t,...e){let i=P.get(t);return i||(i=new T(t),P.set(t,i)),new w(i,e)}function U(t,e){let i=new M(t,e);return()=>i.$redraw()}var M=class{constructor(e,i){typeof e=="string"&&(e=document.querySelector(e));let r=document.createDocumentFragment(),l=document.createComment("Katla");r.appendChild(l);let a=document.createComment("/Katla");r.appendChild(a);let o=C(l,-1,this,i());this.#e=()=>o.Update(i()),e.appendChild(r)}render(){}#e;$redraw(){this.#e()}#t=new Map;$get=e=>this.#t.get(e);$set=(e,i)=>{this.#t.set(e,i)}};var I=class{deps;render2;#e;render(){if(this.#e&&this.#e.length===this.deps.length){let e=!0;for(let i=0;i<this.#e.length;i++)if(this.#e[i]!==this.deps[i]){e=!1;break}if(e)return this.deps=void 0,new x}return this.#e=Object.assign({},this.deps),this.deps=void 0,this.render2()}};function K(t,e){if(!t||!Array.isArray(t))throw new Error("Katla: memo deps argument must be array");if(!e||typeof e!="function")throw new Error("Katla: memo render argument must be function");return[I,{deps:t,render2:e}]}function k(t){let e={PostBack(){return s(null,[])}},i=[],r=new Map;for(let p of t.state)l(p);r.size>0&&a();for(let p of t.funcs)e[p]=(...f)=>s(p,f);function l(p){let f=p[0],d=p[1];if(p[2]&&i.push(f),p.length<=3){e[f]=d;return}Object.defineProperty(e,f,{get:()=>d,set:m=>{m!==d&&(d=m,a())},enumerable:!0,configurable:!1}),r.set(f,{id:p[3],default:p.length>4?p[4]:null})}function a(){let p=new URLSearchParams,f;for(let d of r)f=e[d[0]],f=typeof f=="boolean"?f?"1":"0":f.toString(),!(d[1].default!==null&&f===d[1].default)&&p.set(d[1].id,f);history.replaceState(null,null,"?"+p.toString())}function o(p,f){throw document.body.innerHTML=`<h1 style='color:red'>Program Error! \u2639\uFE0F</h1>
<p>`+p+` - see log for details.</p>
<p><a href='javascript:location.reload()'>Reload page</a></p>`,f}async function n(p){let f=await p.json();return f.getFile?await u(f.getFile.inputId,f.getFile.fileIdx,f.getFile.cbId):(Object.assign(e,f.state),f.exec&&new Function(f.exec)(),f.funcres)}async function s(p,f){let d={state:{}};for(let c of i)d.state[c]=e[c];p!==null&&(d.func=[p,f]);let m;try{m=await fetch(location.href,{method:"POST",body:JSON.stringify(d),redirect:"error",headers:{"content-type":"application/json","X-Spirit":"X"}})}catch(c){o("Error sending server function request",c)}return m.status>=400&&o("Error sending server function request",new Error("Server response: "+m.status+" "+m.statusText+" (executing server function '"+p+"')")),await n(m)}async function u(p,f,d){let c=document.getElementById(p).files[f],h;try{h=await fetch(location.href,{method:"POST",body:c,redirect:"error",headers:{"X-Spirit-File":d,"content-type":"application/octet-stream","X-Spirit":"X"}})}catch(E){o("Error sending file to server",E)}return h.status>=400&&o("Error sending file to server",new Error("Server response: "+h.status+" "+h.statusText+" (sending file: '"+c.name+"')")),await n(h)}return e}var W=t=>new b(t),G=(t,e)=>y.set(t,e),q=(t,e)=>({redraw:U(t,e)});globalThis.Katla={app:q,html:A,mount:U,raw:W,directive:G,memo:K};globalThis.html=A;globalThis.SpiritInit=k;})();
//# sourceMappingURL=katla.js.map
